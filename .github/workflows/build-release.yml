name: Build Release

on:
     push:
          tags:
             - "v*.*.*"

jobs:
     build_release:
          runs-on: ubuntu-latest
          # Add this permissions block
          permissions:
               contents: write
          steps:
             - uses: actions/checkout @v3

             - name: Setup Neutralinojs
               run: |
                    npm install -g @neutralinojs/neu
                    neu version

             - name: Setup Node.js
               uses: actions/setup-node @v3
               with:
                    node-version: "18"

             - name: Install pnpm
               uses: pnpm/action-setup @v2
               with:
                    version: 8
                    run_install: false

             - name: Get pnpm store directory
               shell: bash
               run: |
                    echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

             - uses: actions/cache @v3
               name: Setup pnpm cache
               with:
                    path: ${{ env.STORE_PATH }}
                    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                    restore-keys: |
                         ${{ runner.os }}-pnpm-store-

             - name: Install dependencies
               run: pnpm install
               working-directory: ./app

             - name: Build Svelte app
               run: pnpm build
               working-directory: ./app

             - name: Build Neutralino app
               run: neu build --release

             - name: Zip build output
               run: |
                    cd dist/linux-wallpaperengine-gui
                    zip -r ../linux-wallpaperengine-gui-release.zip .
                    cd ../..

             - name: Upload release artifact
               uses: actions/upload-artifact @v4
               with:
                    name: linux-wallpaperengine-gui-release
                    path: dist/linux-wallpaperengine-gui-release.zip

             - name: Create GitHub Release
               uses: softprops/action-gh-release @v1
               if: startsWith(github.ref, 'refs/tags/')
               with:
                    files: dist/linux-wallpaperengine-gui-release.zip
