name: Build for Linux

on:
     push:
          branches:
             - main
     workflow_dispatch:


jobs:
     build-and-release-linux:
          runs-on: ubuntu-latest

          permissions:
               contents: write

          steps:
             - name: Checkout code
               uses: actions/checkout@v4

             - name: Install pnpm
               uses: pnpm/action-setup@v4
               with:
                    version: latest

             - name: Use Node.js 20
               uses: actions/setup-node@v4
               with:
                    node-version: 20
                    cache: 'pnpm'
                    cache-dependency-path: pnpm-lock.yaml

             - name: Install dependencies
               run: pnpm install

             - name: Build Electron app for Linux
               run: pnpm build:release

             - name: Get version from package.json
               id: get_version
               run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

             - name: Create or Update Tag
               uses: actions/github-script@v7
               with:
                    script: |
                         const version = process.env.VERSION;
                         const tag = `v${version}`;
                         const ref = `tags/${tag}`;

                         try {
                           await github.rest.git.getRef({
                             owner: context.repo.owner,
                             repo: context.repo.repo,
                             ref,
                           });
                           console.log(`Tag ${tag} already exists. Updating...`);
                           await github.rest.git.updateRef({
                             owner: context.repo.owner,
                             repo: context.repo.repo,
                             ref,
                             sha: context.sha,
                             force: true
                           });
                           console.log(`Updated tag ${tag}`);
                         } catch (error) {
                           if (error.status === 404) {
                             console.log(`Tag ${tag} does not exist. Creating...`);
                             await github.rest.git.createRef({
                               owner: context.repo.owner,
                               repo: context.repo.repo,
                               ref: `refs/${ref}`,
                               sha: context.sha
                             });
                             console.log(`Created tag ${tag}`);
                           } else {
                             throw error;
                           }
                         }
               env:
                    VERSION: ${{ steps.get_version.outputs.VERSION }}

             - name: Create Release and Upload Asset
               uses: softprops/action-gh-release@v2
               with:
                    files: release/*
                    tag_name: v${{ steps.get_version.outputs.VERSION }}
                    name: v${{ steps.get_version.outputs.VERSION }}
                    overwrite: true
               env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
